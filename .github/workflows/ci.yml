name: Unity AI Agents CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      PROJECT_PATH: ${{ secrets.PROJECT_PATH }}

    steps:
    # üì• –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v3

    # üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # ‚öô –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
    - name: Set up .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    # üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # üîç Lint Python –∫–æ–¥–∞
    - name: Lint Python code
      run: |
        pip install flake8
        flake8 agents utils --max-line-length=120

    # üß™ –ó–∞–ø—É—Å–∫ Python —Ç–µ—Å—Ç–æ–≤
    - name: Run Python tests
      run: |
        python test-run.py || echo "‚ö† test-run.py failed ‚Äî continue pipeline"

    # ‚ö° –°–±–æ—Ä–∫–∞ .NET –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
    - name: dotnet build
      run: |
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå PROJECT_PATH is not set. Please set it in repo secrets."
          exit 1
        fi
        echo "üöÄ Building project at $PROJECT_PATH"
        dotnet build "$PROJECT_PATH" > build.log 2>&1 || echo "‚ö† dotnet build failed ‚Äî review build log"

    # üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º build.log –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: build.log
